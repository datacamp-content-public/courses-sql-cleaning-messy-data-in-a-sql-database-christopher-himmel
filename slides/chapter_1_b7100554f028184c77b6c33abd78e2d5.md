---
title: Insert title here
key: b7100554f028184c77b6c33abd78e2d5

---
## Lesson 2.1 - Relational to Flat structure

```yaml
type: "TitleSlide"
key: "6fdc89dd22"
```

`@lower_third`
name: Name Surname
title: Instructor


`@script`
For this exercise we will take separate databases and combine them into one flat database using SQL. This is the required format for Machine Learning.


---
## Marketing Funnel Data Structure

```yaml
type: "FullImageSlide"
key: "13ddc39726"
```

`@part1`
![](https://i.imgur.com/Jory0O3.png)


`@script`
Here you can see the database structure of the data repositories we are interested in in this analysis. The first step in the process is the "Lead", coming from the Marketing Qualified Leads dataset.

Remember, this was a comma delimited file loaded in previously. The second step in the Marketing Funnel is making a "Deal", which is quantified and stored in the Closed Deals dataset.

The "Seller" that made the "Deal" has information associated to him in the Sellers dataset, and the "Items" sold have related information in the Order Items dataset.


---
## Prepare the Programming Environment

```yaml
type: "FullCodeSlide"
key: "4bb67a441a"
```

`@part1`
```
import pandas as pd
import sqlite3

conn = sqlite3.connect("Marketing.db")
```


`@script`
To get our programming environment set up, we will import two Python libraries: pandas for reading the data from CSV, sqlite3 for creating and manipulating the SQLite database.

Then we will use the sqlite3 command "connect" to attach to the SQLite database Marketing.db.  If the database file does not exist yet, this command will create an empty database for use to begin using.


---
## Load data into Pandas Dataframe

```yaml
type: "FullCodeSlide"
key: "66af6deb4e"
center_content: true
disable_transition: false
```

`@part1`
```
#Function to convert CSV to SQL table
def csv_to_sql(csv, sql):
    df = pd.read_csv("data/" + csv + ".csv")
    df.to_sql(sql, conn, if_exists='replace', index=False)
```{{1}}
```
# Marketing Qualified Leads
csv_to_sql('olist_marketing_qualified_leads_dataset','leads')
```{{2}}
```
# Closed Deal
csv_to_sql('olist_closed_deals_dataset','deals')

# Seller List
csv_to_sql('olist_sellers_dataset','sellers')

# Item List
csv_to_sql('olist_order_items_dataset','items')
```{{3}}


`@script`
Next we will read the CSV data we downloaded from Kaggle into the SQL database.

First we will define a function to create a SQL table from a comma delimited file. We will pass the file name, assuming it is in the data folder, and also the SQL table name we will create.

The function will first create a Pandas dataframe, reading in the CSV file. Then we will use a Pandas function to create the SQLite database table from the Pandas dataframe.

The functiom is to_sql, which takes in the SQL table name we will create, the connection to the SQLite database we are creating the table in, and two behavioral parameters. The 'if_exists' parameter determines what the function will do if the table already exists in the database. In our case we will replace the existing table. The last parameter is used to determine if our table will need an index, which in our examples we will not be creating them.

So now we will be calling the function, passing in the CSV table name for the Leads first, and the name "leads" which we will use for the table name in the database.

Likewise we will call the function for the remaining three files, creating the "deals", "sellers" and "items" tables in the database.

As we begin to use these tables, pulling the information together for machine learning, we will take a closer look at the data elements.


---
## Review Leads Table

```yaml
type: "FullCodeSlide"
key: "9a6e5ef4c8"
```

`@part1`
```
pd.read_sql('SELECT * FROM leads LIMIT 5', conn)
```
{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/49b66661883041a66f25e9b2f0ca6765607f023f/Capture.PNG)
{{2}}


`@script`
Now that we have loaded out data, lets take a look at the "leads" table. To do this, we will use another Pandas function, read_sql. This function returns the visual output from the SQL statement you pass in the first argument, run on the connection you pass as the second argument.

You can see here that we are running a simple select statement on the "leads" table in the database referenced by the "conn" object.

So that we don't overload the screen, we are only showing the first five rows of the table.

Note that there are four columns, the first of which is the mql_id, which is the ID of the record, which shows one Marketing Qualified Lead.


---
## Review Deals Table

```yaml
type: "FullCodeSlide"
key: "d0ad5df74c"
```

`@part1`
```
pd.read_sql('SELECT * FROM deals LIMIT 5', conn)
```{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/3c5aa44421a2602c925573095a8f37c61e86cde5/Capture2.PNG)
{{2}}


`@script`
Likewise, we will now review the "Deals" table. In the same manner, we will run the Pandas read_sql function, showing the first five rows of the "deals" table.

Note that there are many more columns than we can show here, and we would just scroll to the right to see more of the columns.

The first column, you will notice is the mql_id, representing the Marketing Qualified Lead that this "deal" was made for. This will be used shortly to tie back to the associated "lead".


---
## Preview Joining Deals to Leads

```yaml
type: "FullCodeSlide"
key: "2c58d7c476"
```

`@part1`
```
pd.read_sql('SELECT * FROM                         \
                 leads LEFT JOIN                   \
                 deals                             \
                     ON leads.mql_id = deals.mql_id\
             LIMIT 5', conn)
```{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/76cb8ecbb68245d8a17d34526a1f6c50996d3acd/Capture3.PNG)
{{2}}


`@script`



---
## Create JOINed Table

```yaml
type: "FullCodeSlide"
key: "d05c1fdc77"
```

`@part1`
```
conn.execute('DROP TABLE IF EXISTS funnel1')

sql_cmd = 'CREATE TABLE funnel1 AS                   \
               SELECT * FROM                         \
                   leads LEFT JOIN                   \
                   deals                             \
                       ON leads.mql_id = deals.mql_id'
conn.execute(sql_cmd)

pd.read_sql('SELECT * FROM funnel1 LIMIT 5', conn)
```{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/71d5f5ee031010f0bf60d437be06b06f8271f9bd/Capture4.PNG)
{{2}}


`@script`



---
## Preview Joining Sellers in

```yaml
type: "FullCodeSlide"
key: "e4b7517c07"
```

`@part1`
```
pd.read_sql('SELECT * FROM                                   \
                 funnel1 LEFT JOIN                           \
                 sellers                                     \
                     ON funnel1.seller_id = sellers.seller_id\
             LIMIT 5', conn)
```{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/7b687e09623563fab2f8f1494754b4ce2713eea6/Capture5.PNG)
{{2}}


`@script`



---
## Create JOINed Table

```yaml
type: "FullCodeSlide"
key: "e263bf1e1b"
```

`@part1`
```
conn.execute('DROP TABLE IF EXISTS funnel2')

sql_cmd = 'CREATE TABLE funnel2 AS                             \
               SELECT * FROM                                   \
                   funnel1 LEFT JOIN                           \
                   sellers                                     \
                       ON funnel1.seller_id = sellers.seller_id'
conn.execute(sql_cmd)

pd.read_sql('SELECT * FROM funnel2 LIMIT 5', conn)
```{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/57a0bc00e7611b0f67c0a7ea08383f4f35d4e6fe/Capture6.PNG)
{{2}}


`@script`



---
## Preview Joining Items in

```yaml
type: "FullCodeSlide"
key: "63d1e22680"
```

`@part1`
```
pd.read_sql('SELECT * FROM                                 \
                 funnel2 LEFT JOIN                         \
                 items                                     \
                     ON funnel2.seller_id = items.seller_id\
             LIMIT 5', conn)
```{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/ed14646e484dfd9f2ba256b6514d971483dc051b/Capture7.PNG)
{{2}}


`@script`



---
## Create JOINed Table

```yaml
type: "FullCodeSlide"
key: "6f3d6b3e9c"
```

`@part1`
```
conn.execute('DROP TABLE IF EXISTS funnels')

sql_cmd = 'CREATE TABLE funnels AS                           \
               SELECT * FROM                                 \
                   funnel2 LEFT JOIN                         \
                   items                                     \
                       ON funnel2.seller_id = items.seller_id'
conn.execute(sql_cmd)

conn.execute('DROP TABLE IF EXISTS funnel1')
conn.execute('DROP TABLE IF EXISTS funnel2')

pd.read_sql('select * from funnels limit 6', conn)
```{{1}}
![](https://assets.datacamp.com/production/repositories/4220/datasets/d9833201a8f4f26441897b125670b84bc1b65167/Capture8.PNG)
{{2}}


`@script`



---
## Final Slide

```yaml
type: "FinalSlide"
key: "a67831b2e8"
```

`@script`


